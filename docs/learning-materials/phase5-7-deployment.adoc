= ãƒ•ã‚§ãƒ¼ã‚º5-7: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ - è©³ç´°è§£èª¬
:toc:
:toclevels: 4
:source-highlighter: highlight.js

== ãƒ•ã‚§ãƒ¼ã‚º5: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæº–å‚™

=== 5.1 æœ¬ç•ªç’°å¢ƒå¯¾å¿œ

==== ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

æœ¬ç•ªç’°å¢ƒã§ã¯ã€æ©Ÿå¯†æƒ…å ±ã‚„ç’°å¢ƒå›ºæœ‰ã®è¨­å®šã‚’ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†ã—ã¾ã™ã€‚

[source,typescript]
----
// .env.localï¼ˆé–‹ç™ºç’°å¢ƒç”¨ï¼‰
NEXT_PUBLIC_SITE_URL=http://localhost:3000
NEXT_PUBLIC_API_URL=http://localhost:3000/api
DATABASE_URL=postgresql://user:password@localhost:5432/blog_dev
NEXTAUTH_SECRET=your-secret-key-here
NEXTAUTH_URL=http://localhost:3000

# Google Analytics
NEXT_PUBLIC_GA_ID=G-XXXXXXXXXX

# AWS S3ï¼ˆç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
AWS_REGION=ap-northeast-1
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
AWS_S3_BUCKET_NAME=your-bucket-name
----

[source,typescript]
----
// .env.productionï¼ˆæœ¬ç•ªç’°å¢ƒç”¨ï¼‰
NEXT_PUBLIC_SITE_URL=https://yourdomain.com
NEXT_PUBLIC_API_URL=https://yourdomain.com/api
DATABASE_URL=postgresql://user:password@prod-db:5432/blog_prod
NEXTAUTH_SECRET=super-secret-production-key
NEXTAUTH_URL=https://yourdomain.com

# Google Analytics
NEXT_PUBLIC_GA_ID=G-YYYYYYYYYY

# AWS S3
AWS_REGION=ap-northeast-1
AWS_ACCESS_KEY_ID=prod-access-key
AWS_SECRET_ACCESS_KEY=prod-secret-key
AWS_S3_BUCKET_NAME=prod-bucket-name
----

[source,typescript]
----
// src/lib/env.ts
// ç’°å¢ƒå¤‰æ•°ã®å‹å®‰å…¨ãªç®¡ç†
import { z } from 'zod';

const envSchema = z.object({
  NODE_ENV: z.enum(['development', 'test', 'production']).default('development'),
  NEXT_PUBLIC_SITE_URL: z.string().url(),
  NEXT_PUBLIC_API_URL: z.string().url(),
  DATABASE_URL: z.string(),
  NEXTAUTH_SECRET: z.string(),
  NEXTAUTH_URL: z.string().url(),
  NEXT_PUBLIC_GA_ID: z.string().optional(),
  AWS_REGION: z.string(),
  AWS_ACCESS_KEY_ID: z.string(),
  AWS_SECRET_ACCESS_KEY: z.string(),
  AWS_S3_BUCKET_NAME: z.string(),
});

export const env = envSchema.parse(process.env);

// ä½¿ç”¨ä¾‹
export const siteConfig = {
  name: 'Reactå­¦ç¿’ãƒ–ãƒ­ã‚°',
  description: 'Reactã¨Next.jsã®å­¦ç¿’è¨˜éŒ²',
  url: env.NEXT_PUBLIC_SITE_URL,
  apiUrl: env.NEXT_PUBLIC_API_URL,
  author: 'é–‹ç™ºè€…å',
  social: {
    twitter: '@your_twitter',
    github: 'your-github',
  },
};
----

==== ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

[source,typescript]
----
// src/lib/error-handler.ts
export class AppError extends Error {
  public readonly statusCode: number;
  public readonly isOperational: boolean;

  constructor(message: string, statusCode: number = 500, isOperational: boolean = true) {
    super(message);
    this.statusCode = statusCode;
    this.isOperational = isOperational;

    Error.captureStackTrace(this, this.constructor);
  }
}

export class ValidationError extends AppError {
  constructor(message: string) {
    super(message, 400);
  }
}

export class NotFoundError extends AppError {
  constructor(message: string = 'ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“') {
    super(message, 404);
  }
}

export class UnauthorizedError extends AppError {
  constructor(message: string = 'èªè¨¼ãŒå¿…è¦ã§ã™') {
    super(message, 401);
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
export function handleError(error: Error) {
  if (error instanceof AppError && error.isOperational) {
    // äºˆæœŸã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼
    console.error('Operational Error:', error.message);
  } else {
    // äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼
    console.error('System Error:', error);
    
    // æœ¬ç•ªç’°å¢ƒã§ã¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆSentryç­‰ï¼‰ã«ãƒ­ã‚°é€ä¿¡
    if (process.env.NODE_ENV === 'production') {
      // Sentry.captureException(error);
    }
  }
}
----

[source,typescript]
----
// src/app/global-error.tsx
'use client'

import { useEffect } from 'react';

export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    console.error('Global error:', error);
  }, [error]);

  return (
    <html>
      <body>
        <div className="min-h-screen flex items-center justify-center bg-gray-50">
          <div className="max-w-md mx-auto text-center">
            <div className="bg-white p-8 rounded-lg shadow-md">
              <div className="text-red-500 mb-4">
                <svg className="mx-auto h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
              </div>
              <h1 className="text-2xl font-bold text-gray-900 mb-4">
                ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
              </h1>
              <p className="text-gray-600 mb-6">
                ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
              </p>
              <div className="space-y-3">
                <button
                  onClick={reset}
                  className="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                >
                  å†è©¦è¡Œ
                </button>
                <a
                  href="/"
                  className="block w-full px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                >
                  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                </a>
              </div>
              
              {process.env.NODE_ENV === 'development' && (
                <details className="mt-4 text-left">
                  <summary className="cursor-pointer text-sm text-gray-500">
                    ã‚¨ãƒ©ãƒ¼è©³ç´°ï¼ˆé–‹ç™ºç”¨ï¼‰
                  </summary>
                  <pre className="mt-2 text-xs bg-gray-100 p-2 rounded overflow-auto">
                    {error.message}
                  </pre>
                </details>
              )}
            </div>
          </div>
        </div>
      </body>
    </html>
  );
}
----

==== æœ€é©åŒ–

[source,typescript]
----
// next.config.ts
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  // ç”»åƒæœ€é©åŒ–
  images: {
    domains: ['images.unsplash.com', 'your-domain.com'],
    formats: ['image/webp', 'image/avif'],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
  },

  // å®Ÿé¨“çš„æ©Ÿèƒ½
  experimental: {
    optimizeCss: true,
    optimizePackageImports: ['@heroicons/react'],
  },

  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'origin-when-cross-origin',
          },
          {
            key: 'Content-Security-Policy',
            value: "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://www.googletagmanager.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;",
          },
        ],
      },
    ];
  },

  // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®š
  async redirects() {
    return [
      {
        source: '/home',
        destination: '/',
        permanent: true,
      },
    ];
  },

  // åœ§ç¸®è¨­å®š
  compress: true,

  // é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€é©åŒ–
  poweredByHeader: false,
  
  // Bundle Analyzerï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
  ...(process.env.ANALYZE === 'true' && {
    webpack: (config: any) => {
      config.plugins.push(
        new (require('@next/bundle-analyzer'))({
          enabled: true,
        })
      );
      return config;
    },
  }),
};

export default nextConfig;
----

==== SEOå¯¾ç­–

[source,typescript]
----
// src/app/sitemap.ts
import { MetadataRoute } from 'next';
import { blogPosts } from '@/data/blog-data';
import { siteConfig } from '@/lib/env';

export default function sitemap(): MetadataRoute.Sitemap {
  const staticPages = [
    {
      url: siteConfig.url,
      lastModified: new Date(),
      changeFrequency: 'daily' as const,
      priority: 1,
    },
    {
      url: `${siteConfig.url}/blog`,
      lastModified: new Date(),
      changeFrequency: 'daily' as const,
      priority: 0.9,
    },
    {
      url: `${siteConfig.url}/about`,
      lastModified: new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.8,
    },
  ];

  const blogPages = blogPosts
    .filter(post => post.status === 'published')
    .map(post => ({
      url: `${siteConfig.url}/blog/${post.slug}`,
      lastModified: new Date(post.updatedAt),
      changeFrequency: 'weekly' as const,
      priority: 0.7,
    }));

  return [...staticPages, ...blogPages];
}
----

[source,typescript]
----
// src/app/robots.ts
import { MetadataRoute } from 'next';
import { siteConfig } from '@/lib/env';

export default function robots(): MetadataRoute.Robots {
  return {
    rules: [
      {
        userAgent: '*',
        allow: '/',
        disallow: ['/admin/', '/api/'],
      },
    ],
    sitemap: `${siteConfig.url}/sitemap.xml`,
  };
}
----

[source,typescript]
----
// src/components/analytics/GoogleAnalytics.tsx
'use client'

import Script from 'next/script';
import { env } from '@/lib/env';

export default function GoogleAnalytics() {
  if (!env.NEXT_PUBLIC_GA_ID) {
    return null;
  }

  return (
    <>
      <Script
        src={`https://www.googletagmanager.com/gtag/js?id=${env.NEXT_PUBLIC_GA_ID}`}
        strategy="afterInteractive"
      />
      <Script id="google-analytics" strategy="afterInteractive">
        {`
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', '${env.NEXT_PUBLIC_GA_ID}', {
            page_title: document.title,
            page_location: window.location.href,
          });
        `}
      </Script>
    </>
  );
}
----

=== 5.2 ãƒ†ã‚¹ãƒˆ

==== å˜ä½“ãƒ†ã‚¹ãƒˆã®ä½œæˆ

[source,javascript]
----
// jest.config.js
const nextJest = require('next/jest');

const createJestConfig = nextJest({
  dir: './',
});

const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  testEnvironment: 'jest-environment-jsdom',
  testPathIgnorePatterns: ['<rootDir>/.next/', '<rootDir>/node_modules/'],
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.stories.{js,jsx,ts,tsx}',
  ],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
};

module.exports = createJestConfig(customJestConfig);
----

[source,javascript]
----
// jest.setup.js
import '@testing-library/jest-dom';

// IntersectionObserver ã®ãƒ¢ãƒƒã‚¯
global.IntersectionObserver = jest.fn().mockImplementation(() => ({
  observe: jest.fn(),
  unobserve: jest.fn(),
  disconnect: jest.fn(),
}));

// matchMedia ã®ãƒ¢ãƒƒã‚¯
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: jest.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: jest.fn(),
    removeListener: jest.fn(),
    addEventListener: jest.fn(),
    removeEventListener: jest.fn(),
    dispatchEvent: jest.fn(),
  })),
});
----

[source,typescript]
----
// src/components/__tests__/Button.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import Button from '@/components/ui/Button';

describe('Button', () => {
  it('æ­£ã—ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹', () => {
    render(<Button>ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³</Button>);
    expect(screen.getByRole('button', { name: 'ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³' })).toBeInTheDocument();
  });

  it('ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒæ­£ã—ãå‹•ä½œã™ã‚‹', () => {
    const mockClick = jest.fn();
    render(<Button onClick={mockClick}>ã‚¯ãƒªãƒƒã‚¯</Button>);
    
    fireEvent.click(screen.getByRole('button'));
    expect(mockClick).toHaveBeenCalledTimes(1);
  });

  it('disabledçŠ¶æ…‹ã§æ­£ã—ãå‹•ä½œã™ã‚‹', () => {
    const mockClick = jest.fn();
    render(<Button onClick={mockClick} disabled>ç„¡åŠ¹ãƒœã‚¿ãƒ³</Button>);
    
    const button = screen.getByRole('button');
    expect(button).toBeDisabled();
    
    fireEvent.click(button);
    expect(mockClick).not.toHaveBeenCalled();
  });

  it('ãƒãƒªã‚¢ãƒ³ãƒˆåˆ¥ã®ã‚¹ã‚¿ã‚¤ãƒ«ãŒé©ç”¨ã•ã‚Œã‚‹', () => {
    const { rerender } = render(<Button variant="secondary">ã‚»ã‚«ãƒ³ãƒ€ãƒª</Button>);
    expect(screen.getByRole('button')).toHaveClass('bg-gray-200');

    rerender(<Button variant="destructive">å‰Šé™¤</Button>);
    expect(screen.getByRole('button')).toHaveClass('bg-red-600');
  });
});
----

[source,typescript]
----
// src/lib/__tests__/blog-utils.test.ts
import { generateSlug, formatDate, calculateReadingTime } from '@/lib/blog-utils';

describe('blog-utils', () => {
  describe('generateSlug', () => {
    it('æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«ã‚’æ­£ã—ã„ã‚¹ãƒ©ãƒƒã‚°ã«å¤‰æ›ã™ã‚‹', () => {
      expect(generateSlug('Reactã®åŸºæœ¬æ¦‚å¿µã«ã¤ã„ã¦')).toBe('react-no-kihon-gainen-ni-tsuite');
      expect(generateSlug('Next.js App Routerå®Œå…¨ã‚¬ã‚¤ãƒ‰')).toBe('next-js-app-router-kanzen-gaido');
    });

    it('ç‰¹æ®Šæ–‡å­—ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹', () => {
      expect(generateSlug('React & Next.js: å®Œå…¨ã‚¬ã‚¤ãƒ‰')).toBe('react-next-js-kanzen-gaido');
      expect(generateSlug('Vue.js vs React - ã©ã¡ã‚‰ã‚’é¸ã¶ï¼Ÿ')).toBe('vue-js-vs-react-dochira-wo-erabu');
    });
  });

  describe('formatDate', () => {
    it('æ—¥ä»˜ã‚’æ­£ã—ã„å½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹', () => {
      const date = new Date('2024-01-15T10:00:00Z');
      expect(formatDate(date, 'ja-JP')).toBe('2024å¹´1æœˆ15æ—¥');
      expect(formatDate(date, 'en-US')).toBe('January 15, 2024');
    });
  });

  describe('calculateReadingTime', () => {
    it('èª­äº†æ™‚é–“ã‚’æ­£ã—ãè¨ˆç®—ã™ã‚‹', () => {
      const shortText = 'ã“ã‚Œã¯çŸ­ã„ãƒ†ã‚­ã‚¹ãƒˆã§ã™ã€‚'.repeat(50); // ç´„50èª
      expect(calculateReadingTime(shortText)).toBe(1);

      const longText = 'ã“ã‚Œã¯é•·ã„ãƒ†ã‚­ã‚¹ãƒˆã§ã™ã€‚'.repeat(500); // ç´„500èª
      expect(calculateReadingTime(longText)).toBe(3);
    });
  });
});
----

==== çµ±åˆãƒ†ã‚¹ãƒˆã®ä½œæˆ

[source,typescript]
----
// src/__tests__/api/posts.test.ts
import { createMocks } from 'node-mocks-http';
import { GET, POST } from '@/app/api/posts/route';

describe('/api/posts', () => {
  describe('GET', () => {
    it('è¨˜äº‹ä¸€è¦§ã‚’æ­£ã—ãå–å¾—ã§ãã‚‹', async () => {
      const { req } = createMocks({
        method: 'GET',
        url: '/api/posts',
      });

      const response = await GET(req as any);
      const data = await response.json();

      expect(response.status).toBe(200);
      expect(data.posts).toBeInstanceOf(Array);
      expect(data.total).toBeGreaterThanOrEqual(0);
    });

    it('ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒæ­£ã—ãå‹•ä½œã™ã‚‹', async () => {
      const { req } = createMocks({
        method: 'GET',
        url: '/api/posts?tag=react',
      });

      const response = await GET(req as any);
      const data = await response.json();

      expect(response.status).toBe(200);
      data.posts.forEach((post: any) => {
        expect(post.tags.some((tag: any) => 
          tag.slug.toLowerCase().includes('react')
        )).toBe(true);
      });
    });
  });

  describe('POST', () => {
    it('æ–°ã—ã„è¨˜äº‹ã‚’æ­£ã—ãä½œæˆã§ãã‚‹', async () => {
      const { req } = createMocks({
        method: 'POST',
        body: {
          title: 'ãƒ†ã‚¹ãƒˆè¨˜äº‹',
          content: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆè¨˜äº‹ã®å†…å®¹ã§ã™ã€‚',
          author: 'ãƒ†ã‚¹ãƒˆä½œæˆè€…',
          tags: ['test', 'blog'],
        },
      });

      const response = await POST(req as any);
      const data = await response.json();

      expect(response.status).toBe(201);
      expect(data.post.title).toBe('ãƒ†ã‚¹ãƒˆè¨˜äº‹');
      expect(data.post.author).toBe('ãƒ†ã‚¹ãƒˆä½œæˆè€…');
    });

    it('å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™', async () => {
      const { req } = createMocks({
        method: 'POST',
        body: {
          title: 'ãƒ†ã‚¹ãƒˆè¨˜äº‹',
          // contentã¨authorãŒä¸è¶³
        },
      });

      const response = await POST(req as any);
      const data = await response.json();

      expect(response.status).toBe(400);
      expect(data.error).toContain('å¿…é ˆé …ç›®');
    });
  });
});
----

==== E2Eãƒ†ã‚¹ãƒˆã®ä½œæˆ

[source,typescript]
----
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});
----

[source,typescript]
----
// e2e/blog.spec.ts
import { test, expect } from '@playwright/test';

test.describe('ãƒ–ãƒ­ã‚°æ©Ÿèƒ½', () => {
  test('ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
    await page.goto('/');
    
    // ã‚¿ã‚¤ãƒˆãƒ«ã®ç¢ºèª
    await expect(page).toHaveTitle(/Reactå­¦ç¿’ãƒ–ãƒ­ã‚°/);
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¢ºèª
    await expect(page.getByRole('navigation')).toBeVisible();
    await expect(page.getByRole('link', { name: 'ãƒ–ãƒ­ã‚°' })).toBeVisible();
  });

  test('ãƒ–ãƒ­ã‚°ä¸€è¦§ãƒšãƒ¼ã‚¸ãŒæ­£ã—ãå‹•ä½œã™ã‚‹', async ({ page }) => {
    await page.goto('/blog');
    
    // è¨˜äº‹ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºç¢ºèª
    await expect(page.getByTestId('blog-post-card')).toHaveCount(6);
    
    // æ¤œç´¢æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
    await page.getByPlaceholder('è¨˜äº‹ã‚’æ¤œç´¢').fill('React');
    await page.getByRole('button', { name: 'æ¤œç´¢' }).click();
    
    // æ¤œç´¢çµæœã®ç¢ºèª
    await expect(page.getByText('React')).toBeVisible();
  });

  test('è¨˜äº‹è©³ç´°ãƒšãƒ¼ã‚¸ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
    await page.goto('/blog');
    
    // æœ€åˆã®è¨˜äº‹ã‚’ã‚¯ãƒªãƒƒã‚¯
    await page.getByTestId('blog-post-card').first().click();
    
    // è¨˜äº‹è©³ç´°ãƒšãƒ¼ã‚¸ã®ç¢ºèª
    await expect(page.getByRole('article')).toBeVisible();
    await expect(page.getByRole('heading', { level: 1 })).toBeVisible();
    
    // ç›®æ¬¡ã®ç¢ºèª
    await expect(page.getByTestId('table-of-contents')).toBeVisible();
    
    // ã„ã„ã­ãƒœã‚¿ãƒ³ã®ãƒ†ã‚¹ãƒˆ
    const likeButton = page.getByTestId('like-button');
    const initialLikes = await likeButton.textContent();
    await likeButton.click();
    await expect(likeButton).not.toHaveText(initialLikes!);
  });

  test('ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ãŒæ­£ã—ãå‹•ä½œã™ã‚‹', async ({ page }) => {
    // ãƒ¢ãƒã‚¤ãƒ«ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã«è¨­å®š
    await page.setViewportSize({ width: 375, height: 667 });
    await page.goto('/blog');
    
    // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®ç¢ºèª
    await expect(page.getByTestId('mobile-menu-button')).toBeVisible();
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã
    await page.getByTestId('mobile-menu-button').click();
    await expect(page.getByTestId('mobile-menu')).toBeVisible();
    
    // è¨˜äº‹ã‚«ãƒ¼ãƒ‰ãŒãƒ¢ãƒã‚¤ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    const postCards = page.getByTestId('blog-post-card');
    await expect(postCards.first()).toBeVisible();
  });

  test('æ¤œç´¢æ©Ÿèƒ½ãŒæ­£ã—ãå‹•ä½œã™ã‚‹', async ({ page }) => {
    await page.goto('/blog');
    
    // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«å…¥åŠ›
    await page.getByPlaceholder('è¨˜äº‹ã‚’æ¤œç´¢').fill('Next.js');
    await page.keyboard.press('Enter');
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç¢ºèª
    expect(page.url()).toContain('search=Next.js');
    
    // æ¤œç´¢çµæœã®ç¢ºèª
    await expect(page.getByText('Next.js')).toBeVisible();
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚¯ãƒªã‚¢
    await page.getByRole('button', { name: 'ã‚¯ãƒªã‚¢' }).click();
    expect(page.url()).not.toContain('search=');
  });
});
----

== ãƒ•ã‚§ãƒ¼ã‚º6: AWS EC2ãƒ‡ãƒ—ãƒ­ã‚¤

=== 6.1 AWSåŸºç¤çŸ¥è­˜

==== AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã¨IAMè¨­å®š

[source,bash]
----
# AWS CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

# AWS CLI ã®è¨­å®š
aws configure
# AWS Access Key ID: YOUR_ACCESS_KEY
# AWS Secret Access Key: YOUR_SECRET_KEY
# Default region name: ap-northeast-1
# Default output format: json

# IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒªã‚·ãƒ¼ã®ä¾‹ï¼ˆæœ€å°æ¨©é™ï¼‰
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ec2:DescribeInstances",
        "ec2:DescribeImages",
        "ec2:DescribeSecurityGroups",
        "ec2:DescribeKeyPairs",
        "ec2:RunInstances",
        "ec2:TerminateInstances",
        "ec2:CreateSecurityGroup",
        "ec2:AuthorizeSecurityGroupIngress",
        "ec2:CreateKeyPair"
      ],
      "Resource": "*"
    }
  ]
}
----

=== 6.2 ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè£…

==== EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ

[source,bash]
----
# ã‚­ãƒ¼ãƒšã‚¢ã®ä½œæˆ
aws ec2 create-key-pair \
  --key-name blog-app-key \
  --query 'KeyMaterial' \
  --output text > blog-app-key.pem

# ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™è¨­å®š
chmod 400 blog-app-key.pem

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
aws ec2 create-security-group \
  --group-name blog-app-sg \
  --description "Security group for blog app"

# HTTP(80), HTTPS(443), SSH(22) ã®è¨±å¯
aws ec2 authorize-security-group-ingress \
  --group-name blog-app-sg \
  --protocol tcp \
  --port 22 \
  --cidr 0.0.0.0/0

aws ec2 authorize-security-group-ingress \
  --group-name blog-app-sg \
  --protocol tcp \
  --port 80 \
  --cidr 0.0.0.0/0

aws ec2 authorize-security-group-ingress \
  --group-name blog-app-sg \
  --protocol tcp \
  --port 443 \
  --cidr 0.0.0.0/0

aws ec2 authorize-security-group-ingress \
  --group-name blog-app-sg \
  --protocol tcp \
  --port 3000 \
  --cidr 0.0.0.0/0

# EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®èµ·å‹•
aws ec2 run-instances \
  --image-id ami-0d52744d6551d851e \
  --count 1 \
  --instance-type t2.micro \
  --key-name blog-app-key \
  --security-groups blog-app-sg \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=blog-app-server}]'
----

==== ã‚µãƒ¼ãƒãƒ¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

[source,bash]
----
#!/bin/bash
# setup-server.sh - EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åˆæœŸè¨­å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆ

# ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
sudo yum update -y

# Node.js ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆNode.js 18 LTSï¼‰
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# Git ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo yum install -y git

# PM2 ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ï¼‰
sudo npm install -g pm2

# Nginx ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo amazon-linux-extras install nginx1 -y

# Nginx ã®èµ·å‹•ã¨è‡ªå‹•èµ·å‹•è¨­å®š
sudo systemctl start nginx
sudo systemctl enable nginx

# Let's Encrypt ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆSSLè¨¼æ˜æ›¸ç”¨ï¼‰
sudo yum install -y certbot python3-certbot-nginx

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
sudo mkdir -p /var/www/blog-app
sudo chown ec2-user:ec2-user /var/www/blog-app

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¯ãƒ­ãƒ¼ãƒ³
cd /var/www/blog-app
git clone https://github.com/your-username/blog-app.git .

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm ci --only=production

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
cat > .env.production << EOF
NODE_ENV=production
NEXT_PUBLIC_SITE_URL=https://yourdomain.com
NEXT_PUBLIC_API_URL=https://yourdomain.com/api
# ãã®ä»–ã®ç’°å¢ƒå¤‰æ•°...
EOF

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
npm run build

# PM2 ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
pm2 start npm --name "blog-app" -- start
pm2 save
pm2 startup

echo "ã‚µãƒ¼ãƒãƒ¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
----

==== Nginxè¨­å®š

[source,nginx]
----
# /etc/nginx/conf.d/blog-app.conf
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    # HTTP ã‹ã‚‰ HTTPS ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    # SSL è¨¼æ˜æ›¸è¨­å®šï¼ˆLet's Encryptï¼‰
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "origin-when-cross-origin";

    # Gzip åœ§ç¸®
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š
    location /_next/static/ {
        alias /var/www/blog-app/.next/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location /images/ {
        alias /var/www/blog-app/public/images/;
        expires 1y;
        add_header Cache-Control "public";
    }

    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ãƒ—ãƒ­ã‚­ã‚·
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }

    # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
----

==== ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

[source,bash]
----
#!/bin/bash
# deploy.sh - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -e

SERVER_IP="your-ec2-ip"
KEY_PATH="./blog-app-key.pem"
APP_DIR="/var/www/blog-app"

echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™..."

# ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ã§ã®ä½œæ¥­
ssh -i $KEY_PATH ec2-user@$SERVER_IP << 'ENDSSH'
    set -e
    
    echo "ğŸ“¥ æœ€æ–°ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ä¸­..."
    cd /var/www/blog-app
    git fetch origin
    git reset --hard origin/main
    
    echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ä¸­..."
    npm ci --only=production
    
    echo "ğŸ”¨ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
    npm run build
    
    echo "ğŸ”„ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•ä¸­..."
    pm2 restart blog-app
    pm2 save
    
    echo "ğŸ§¹ å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¸…ç†ä¸­..."
    pm2 flush blog-app
    
    echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
ENDSSH

echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
echo "ã‚µã‚¤ãƒˆ URL: https://yourdomain.com"
----

==== ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã¨SSLè¨¼æ˜æ›¸

[source,bash]
----
#!/bin/bash
# setup-ssl.sh - SSLè¨¼æ˜æ›¸è¨­å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆ

DOMAIN="yourdomain.com"
EMAIL="your-email@example.com"

echo "ğŸ”’ SSLè¨¼æ˜æ›¸ã‚’è¨­å®šä¸­..."

# Let's Encrypt ã§ SSLè¨¼æ˜æ›¸ã‚’å–å¾—
sudo certbot --nginx \
  --non-interactive \
  --agree-tos \
  --email $EMAIL \
  --domains $DOMAIN,www.$DOMAIN

# è¨¼æ˜æ›¸ã®è‡ªå‹•æ›´æ–°è¨­å®š
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -

# Nginx ã®å†èµ·å‹•
sudo systemctl restart nginx

echo "âœ… SSLè¨¼æ˜æ›¸ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ"
echo "ã‚µã‚¤ãƒˆ URL: https://$DOMAIN"
----

== ãƒ•ã‚§ãƒ¼ã‚º7: ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç§»è¡Œ

=== 7.1 ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹åŸºç¤

==== Vercelã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

[source,json]
----
// vercel.json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/next"
    }
  ],
  "regions": ["nrt1"],
  "env": {
    "NODE_ENV": "production"
  },
  "build": {
    "env": {
      "NEXT_PUBLIC_SITE_URL": "https://your-app.vercel.app",
      "NEXT_PUBLIC_API_URL": "https://your-app.vercel.app/api"
    }
  },
  "functions": {
    "src/app/api/**/*.ts": {
      "maxDuration": 30
    }
  },
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        }
      ]
    }
  ],
  "redirects": [
    {
      "source": "/home",
      "destination": "/",
      "permanent": true
    }
  ]
}
----

[source,bash]
----
# Vercel CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm i -g vercel

# Vercel ã«ãƒ­ã‚°ã‚¤ãƒ³
vercel login

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
vercel

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
vercel env add NEXT_PUBLIC_SITE_URL production
vercel env add DATABASE_URL production
vercel env add NEXTAUTH_SECRET production

# ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --prod
----

=== 7.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç§»è¡Œ

==== AWS SAM ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

[source,yaml]
----
# template.yaml
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Blog App Serverless Architecture

Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: nodejs18.x

Parameters:
  Environment:
    Type: String
    Default: prod
    AllowedValues: [dev, staging, prod]

Resources:
  # DynamoDB Table
  BlogPostsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'blog-posts-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: slug
          AttributeType: S
        - AttributeName: publishedAt
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: slug-index
          KeySchema:
            - AttributeName: slug
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: published-index
          KeySchema:
            - AttributeName: publishedAt
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  # API Gateway
  BlogApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Environment
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"

  # Lambda Functions
  GetPostsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/lambda/
      Handler: posts.getPosts
      Environment:
        Variables:
          POSTS_TABLE: !Ref BlogPostsTable
      Events:
        GetPosts:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /posts
            Method: get

  GetPostFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/lambda/
      Handler: posts.getPost
      Environment:
        Variables:
          POSTS_TABLE: !Ref BlogPostsTable
      Events:
        GetPost:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /posts/{id}
            Method: get

  CreatePostFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/lambda/
      Handler: posts.createPost
      Environment:
        Variables:
          POSTS_TABLE: !Ref BlogPostsTable
      Events:
        CreatePost:
          Type: Api
          Properties:
            RestApiId: !Ref BlogApi
            Path: /posts
            Method: post

  # S3 Bucket for Static Assets
  StaticAssetsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'blog-static-assets-${Environment}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false

  # CloudFront Distribution
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad # Managed-CachingOptimized
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt StaticAssetsBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: ''

Outputs:
  ApiUrl:
    Description: "API Gateway endpoint URL"
    Value: !Sub "https://${BlogApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
  
  StaticAssetsUrl:
    Description: "CloudFront distribution URL"
    Value: !GetAtt CloudFrontDistribution.DomainName
----

==== Lambda é–¢æ•°ã®å®Ÿè£…

[source,typescript]
----
// src/lambda/posts.ts
import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';
import { DynamoDBClient } from '@aws-sdk/client-dynamodb';
import { DynamoDBDocumentClient, ScanCommand, GetCommand, PutCommand } from '@aws-sdk/lib-dynamodb';

const client = new DynamoDBClient({ region: process.env.AWS_REGION });
const dynamo = DynamoDBDocumentClient.from(client);
const tableName = process.env.POSTS_TABLE!;

export const getPosts = async (event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> => {
  try {
    const { tag, category, limit = '10' } = event.queryStringParameters || {};
    
    const command = new ScanCommand({
      TableName: tableName,
      FilterExpression: 'attribute_exists(id)',
      Limit: parseInt(limit),
    });

    const result = await dynamo.send(command);
    let posts = result.Items || [];

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if (tag) {
      posts = posts.filter(post => 
        post.tags && post.tags.some((t: any) => t.slug === tag)
      );
    }

    if (category) {
      posts = posts.filter(post => post.category && post.category.slug === category);
    }

    return {
      statusCode: 200,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({
        posts,
        total: posts.length,
        timestamp: new Date().toISOString(),
      }),
    };
  } catch (error) {
    console.error('Error getting posts:', error);
    return {
      statusCode: 500,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({
        error: 'Internal server error',
      }),
    };
  }
};

export const getPost = async (event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> => {
  try {
    const { id } = event.pathParameters || {};
    
    if (!id) {
      return {
        statusCode: 400,
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
        },
        body: JSON.stringify({
          error: 'Post ID is required',
        }),
      };
    }

    const command = new GetCommand({
      TableName: tableName,
      Key: { id },
    });

    const result = await dynamo.send(command);
    
    if (!result.Item) {
      return {
        statusCode: 404,
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
        },
        body: JSON.stringify({
          error: 'Post not found',
        }),
      };
    }

    // ãƒ“ãƒ¥ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—åŠ 
    const updateCommand = new PutCommand({
      TableName: tableName,
      Item: {
        ...result.Item,
        viewCount: (result.Item.viewCount || 0) + 1,
        updatedAt: new Date().toISOString(),
      },
    });

    await dynamo.send(updateCommand);

    return {
      statusCode: 200,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({
        post: {
          ...result.Item,
          viewCount: (result.Item.viewCount || 0) + 1,
        },
      }),
    };
  } catch (error) {
    console.error('Error getting post:', error);
    return {
      statusCode: 500,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({
        error: 'Internal server error',
      }),
    };
  }
};

export const createPost = async (event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> => {
  try {
    const body = JSON.parse(event.body || '{}');
    const { title, content, author, category, tags = [] } = body;

    if (!title || !content || !author) {
      return {
        statusCode: 400,
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
        },
        body: JSON.stringify({
          error: 'Title, content, and author are required',
        }),
      };
    }

    const post = {
      id: `post-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      title,
      content,
      author,
      category,
      tags,
      slug: title.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
      publishedAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      status: 'published',
      viewCount: 0,
      likeCount: 0,
    };

    const command = new PutCommand({
      TableName: tableName,
      Item: post,
    });

    await dynamo.send(command);

    return {
      statusCode: 201,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({
        message: 'Post created successfully',
        post,
      }),
    };
  } catch (error) {
    console.error('Error creating post:', error);
    return {
      statusCode: 500,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({
        error: 'Internal server error',
      }),
    };
  }
};
----

==== ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

[source,bash]
----
#!/bin/bash
# deploy-serverless.sh

set -e

ENVIRONMENT=${1:-dev}
STACK_NAME="blog-app-${ENVIRONMENT}"

echo "ğŸš€ ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­... (ç’°å¢ƒ: ${ENVIRONMENT})"

# Lambda é–¢æ•°ã®ãƒ“ãƒ«ãƒ‰
echo "ğŸ“¦ Lambda é–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
cd src/lambda
npm ci
npm run build
cd ../..

# SAM ãƒ“ãƒ«ãƒ‰
echo "ğŸ”¨ SAM ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
sam build

# SAM ãƒ‡ãƒ—ãƒ­ã‚¤
echo "â˜ï¸ AWS ã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
sam deploy \
  --stack-name $STACK_NAME \
  --capabilities CAPABILITY_IAM \
  --parameter-overrides Environment=$ENVIRONMENT \
  --no-confirm-changeset

# ã‚¹ã‚¿ãƒƒã‚¯æƒ…å ±ã®å–å¾—
echo "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ:"
aws cloudformation describe-stacks \
  --stack-name $STACK_NAME \
  --query 'Stacks[0].Outputs' \
  --output table

echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
----

== å®Ÿè·µæ¼”ç¿’

=== æ¼”ç¿’10: å®Œå…¨ãªCI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

GitHub Actionsã‚’ä½¿ç”¨ã—ãŸCI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ï¼š

[source,yaml]
----
# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linting
      run: npm run lint
    
    - name: Run type checking
      run: npm run type-check
    
    - name: Run unit tests
      run: npm run test:unit
    
    - name: Run E2E tests
      run: npm run test:e2e

  deploy-staging:
    name: Deploy to Staging
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to Vercel (Staging)
      uses: amondnet/vercel-action@v20
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}

  deploy-production:
    name: Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to Vercel (Production)
      uses: amondnet/vercel-action@v20
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
----

### å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

**ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæº–å‚™**
- [ ] ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- [ ] SEOå¯¾ç­–ã®å®Ÿè£…
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

**ãƒ†ã‚¹ãƒˆ**
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆã®ä½œæˆ
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆã®ä½œæˆ
- [ ] E2Eãƒ†ã‚¹ãƒˆã®ä½œæˆ
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

**AWS EC2ãƒ‡ãƒ—ãƒ­ã‚¤**
- [ ] EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®è¨­å®š
- [ ] Nginxã®è¨­å®š
- [ ] SSLè¨¼æ˜æ›¸ã®è¨­å®š
- [ ] ãƒ‰ãƒ¡ã‚¤ãƒ³ã®è¨­å®š
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ

**ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç§»è¡Œ**
- [ ] Vercelãƒ‡ãƒ—ãƒ­ã‚¤ã®è¨­å®š
- [ ] AWS SAMãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆ
- [ ] Lambdaé–¢æ•°ã®å®Ÿè£…
- [ ] DynamoDBã®è¨­å®š
- [ ] CloudFrontã®è¨­å®š

**CI/CD**
- [ ] GitHub Actionsã®è¨­å®š
- [ ] è‡ªå‹•ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
- [ ] è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã®è¨­å®š
- [ ] ç’°å¢ƒåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤ã®è¨­å®š

**å­¦ç¿’ã®ãƒã‚¤ãƒ³ãƒˆ:**

1. **ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£**: AWSã‚µãƒ¼ãƒ“ã‚¹ã®ç†è§£ã¨æ´»ç”¨
2. **DevOps**: CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰
3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: æœ¬ç•ªç’°å¢ƒã§ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–
4. **ç›£è¦–**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç›£è¦–ã¨ãƒ­ã‚°ç®¡ç†
5. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: è² è·ã«å¿œã˜ãŸã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥

ã“ã‚Œã‚‰ã®å®Ÿè£…ã‚’é€šã˜ã¦ã€æœ¬æ ¼çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é‹ç”¨ã«å¿…è¦ãªã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã—ã¦ãã ã•ã„ã€‚